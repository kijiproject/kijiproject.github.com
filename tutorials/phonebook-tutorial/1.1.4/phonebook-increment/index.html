
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Use Counters</title>
    <meta name="description" content="Use atomic increment in the Phonebook example to calculate talktime.">
    <meta name="author" content="WibiData">
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/twitter/css/github.css" rel="stylesheet" type="text/css" media="all">
    <script src="http://code.jquery.com/jquery-latest.js" type="text/javascript"></script>
    <script src="/assets/themes/twitter/vallenato/vallenato.js" type="text/javascript"></script>
    <link rel="stylesheet" href="/assets/themes/twitter/css/vallenato.css" type="text/css" media="screen">
  </head>

  <body>
    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-fluid">
          <a class="brand" href="http://www.kiji.org">Kiji Community</a>
          <ul class="nav">
            <li class="dropdown">
              <a href="http://www.kiji.org">The Kiji Project</a>
              <ul class="dropdown-menu">
                <li class="menu-item">
                  <a href="http://www.kiji.org/features">Features</a>
                </li>
              </ul>
            </li>
            <li>
              <a href="http://www.kiji.org/architecture">Architecture</a>
            </li>
            <li class="dropdown">
              <a href="http://www.kiji.org/getstarted/">Get Started</a>
              <ul class="dropdown-menu">
                <li class="menu-item">
                  <a href="http://www.kiji.org/getstarted/#Downloads">Downloads</a>
                </li>
                <li class="menu-item">
                  <a href="http://www.kiji.org/getstarted/#Installation">Installation</a>
                </li>
                <li class="menu-item">
                  <a href="http://www.kiji.org/getstarted/#Quick_Start_Guide">Quick Start Guide</a>
                </li>
                <li class="menu-item">
                  <a href="http://www.kiji.org/get-started-with-maven">Getting Started with Maven</a>
                </li>
                <li class="menu-item">
                  <a href="http://www.kiji.org/getstarted/#Training_Services">
                    Training & Services
                  </a>
                </li>
              </ul>
            </li>
            <li class="dropdown">
              <a href="http://www.kiji.org/getinvolved">Get Involved</a>
              <ul class="dropdown-menu">
                <li class="menu-item">
                  <a href="http://www.kiji.org/getinvolved/#Mailing_Lists">Mailing Lists</a>
                </li>
                <li class="menu-item">
                  <a href="http://www.kiji.org/getinvolved/#Source_Code">Source Code</a>
                </li>
                <li class="menu-item">
                  <a href="http://www.kiji.org/getinvolved/#Issue_Tracker">Issue Tracking</a>
                </li>
                <li class="menu-item">
                  <a href="http://www.kiji.org/getinvolved/#Contributing_to_Kiji">
                    Contributing to Kiji
                  </a>
                </li>
              </ul>
            </li>
            <li class="dropdown active">
              <a href="/">Documentation</a>
              <ul class="dropdown-menu">
                <li class="menu-item">
                  <a href="http://www.kiji.org/getstarted/#Quick_Start_Guide">Quick Start Guide</a>
                </li>
                <li class="menu-item">
                  <a href="/tutorials.html">Tutorials</a>
                </li>
                <li class="menu-item">
                  <a href="/userguides.html">
                    User Guides
                  </a>
                </li>
                <li class="menu-item">
                  <a href="/apidocs">API Reference</a>
                </li>
                <li class="menu-item">
                  <a href="https://github.com/kijiproject/wiki/wiki">Wiki</a>
                </li>
              </ul>
            </li>
            <li>
              <a href="http://www.kiji.org/blog/">Blog</a>
            </li>
            <li>
              <a href="http://www.kiji.org/aboutkiji">About Kiji</a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <div class="container-fluid">
      <div class="content">
        
<div class="row-fluid">
  <div class="span9">
    <div class="page-header">
      <h1>Use Counters</h1>
    </div>

    <div class="pagination">
      <ul>
    
      
      
    
      

      
        
        
          
            
            
          
        
          
        
          
            
            
          
        
          
        
          
            
            
          
        
          
        
          
            
            
          
        
          
        
          
        
          
            
            
          
        
          
            
            
              <li class="prev">
                <a href="/tutorials/phonebook-tutorial/1.1.4/phonebook-derived-columns" title="Derive Data">
                &larr; Previous
                </a>
              </li>
            
          
        
          
        
          
            
            
          
        
          
        
          
        
          
            
            
          
        
      

      
      
        
        
          
            
            
          
        
          
        
          
            
            
          
        
          
        
          
            
            
          
        
          
        
          
            
            
          
        
          
        
          
        
          
            
            
          
        
          
            
            
          
        
          
        
          
            
            
              <li class="next">
                <a href="/tutorials/phonebook-tutorial/1.1.4/phonebook-delete" title="Delete Contacts">
                Next &rarr;
                </a>
              </li>
            
          
        
          
        
          
        
          
            
            
          
        
      
      </ul>
    </div>

    <p>You have just run out of minutes on your phone plan and want to find the person responsible
for inconveniencing you this way. Luckily, we have provided you with a phone log with the
time spent per phone call at <code>$KIJI_HOME/examples/phonebook/input-phone-log.txt</code>. You want to
be able to get the total time spent talking to each of your contacts this month.</p>

<p>To support operations like this Kiji provides atomic counter type cells like HBase that
permit multiple sources to be simultaneously incrementing the cell without conflict. In
this example, we will use the <code>stats:talktime</code> column of counters to count the total
talktime for each of your contacts.</p>

<p>Running the <code>describe phonebook;</code> command within the kiji-schema-shell should print the
<code>stats:talktime</code> as a column of counter cells:</p>

<pre><code>...

Column family: stats
  Description: Statistics about a contact.

  Column stats:talktime (Time spent talking with this person)
    Schema: (counter)
</code></pre>

<p>We'll show you a way to use counters to get the amount of time that each of your contacts has
spent calling you with the IncrementTalkTime example.</p>

<h3>IncrementTalkTime.java</h3>

<div class="row">
  <div class="span2">&nbsp;</div>
  <div class="span8" style="background-color:#eee; border-radius: 6px; padding: 10px">
    <h3>Deprecation Warning</h3>
    <p>
      This section refers to classes in the <tt>org.kiji.schema.mapreduce</tt> package
      that may be removed in the future. You should use the KijiMR library to manage
      MapReduce jobs that interoperate with Kiji tables. In particular, the
      <tt>KijiMapReduceJobBuilder</tt> takes care of lots of things you'd have to do
      manually here (e.g., use <tt>GenericTableMapReduceUtil</tt> and
      <tt>DistributedCacheJars</tt>).
    </p>
  </div>
</div>


<p>The <code>stats:talktime</code> column of the phonebook table is of the type COUNTER. You can see this by
looking at the layout files. As Kiji tables are based on Hbase, they also provide the ability to
treat columns as counters.</p>

<p>IncrementTalkTime uses MapReduce to calculate the talk time per person in the call log by
extending the Hadoop Mapper class. You can find more information about Hadoop MapReduce <a href="http://hadoop.apache.org/">here</a>.</p>

<p>The application starts by configuring a Hadoop job. Note that we need to ship certain jars
that we depend on during the <em>map</em> task. Here\'s how we do this:</p>

<div class="highlight"><pre><code class="java"><span class="n">GenericTableMapReduceUtil</span><span class="o">.</span><span class="na">addAllDependencyJars</span><span class="o">(</span><span class="n">job</span><span class="o">);</span>
<span class="n">DistributedCacheJars</span><span class="o">.</span><span class="na">addJarsToDistributedCache</span><span class="o">(</span><span class="n">job</span><span class="o">,</span>
    <span class="k">new</span> <span class="nf">File</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">getenv</span><span class="o">(</span><span class="s">&quot;KIJI_HOME&quot;</span><span class="o">),</span> <span class="s">&quot;lib&quot;</span><span class="o">));</span>
<span class="n">job</span><span class="o">.</span><span class="na">setUserClassesTakesPrecedence</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</code></pre></div>


<p>The map function is run once per each line in the phone log file. The input to the function
is a line of the form:</p>

<blockquote><p>firstname | lastname | call_duration</p></blockquote>

<p>The <code>setup</code> function is called once per mapper. It opens the phonebook kiji table and creates
a context to be able to write to it. Specifically, the calculated total talk time per contact
will be written to the contact's record.</p>

<p>The map task breaks the input line up into its individual components. It then generates a row ID
for this user in the Kiji table as follows:</p>

<div class="highlight"><pre><code class="java"><span class="kd">final</span> <span class="n">EntityId</span> <span class="n">user</span> <span class="o">=</span> <span class="n">mKijiTable</span><span class="o">.</span><span class="na">getEntityId</span><span class="o">(</span><span class="n">firstName</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span> <span class="o">+</span> <span class="n">lastName</span><span class="o">);</span>
</code></pre></div>


<p>The following code increments the existing value of the <code>stats:talktime</code> column by the call
duration in the call log.</p>

<div class="highlight"><pre><code class="java"><span class="n">mWriter</span><span class="o">.</span><span class="na">increment</span><span class="o">(</span><span class="n">user</span><span class="o">,</span> <span class="s">&quot;stats&quot;</span><span class="o">,</span> <span class="s">&quot;talktime&quot;</span><span class="o">,</span> <span class="n">talkTime</span><span class="o">);</span>
</code></pre></div>


<h3>Running the Example</h3>

<p>First you need to add the phone log to hdfs. You can do this by using the <code>hdfs -copyFromLocal</code>
command.</p>

<div class="userinput">

<div class="highlight"><pre><code class="bash"><span class="nv">$HADOOP_HOME</span>/bin/hadoop fs -copyFromLocal <span class="se">\</span>
    <span class="nv">$KIJI_HOME</span>/examples/phonebook/input-phone-log.txt /tmp
</code></pre></div>

</div>


<p>You can then run the <code>kiji jar</code> command, much like the previous examples, providing the path
to the file in hdfs.</p>

<div class="userinput">

<div class="highlight"><pre><code class="bash"><span class="nv">$KIJI_HOME</span>/bin/kiji jar <span class="se">\</span>
    <span class="nv">$KIJI_HOME</span>/examples/phonebook/lib/kiji-phonebook-1.1.4.jar <span class="se">\</span>
    org.kiji.examples.phonebook.IncrementTalkTime /tmp/input-phone-log.txt
</code></pre></div>

</div>


<h4>Verify</h4>

<p>Now we can look up the derived talktime value from the stats column for the user John Doe using the <code>kiji get</code> command:</p>

<div class="userinput">

<div class="highlight"><pre><code class="bash"><span class="nv">$KIJI_HOME</span>/bin/kiji get kiji://.env/default/phonebook/stats <span class="se">\</span>
    --entity-id<span class="o">=</span><span class="s1">&#39;&quot;John,Doe&quot;&#39;</span>
</code></pre></div>

</div>


<pre><code>Looking up entity: ['John,Doe'] from kiji table: kiji://localhost:2181/default/phonebook/stats/
entity-id=['John,Doe'] [1363228284547] stats:talktime
                                 15
</code></pre>


    <div class="pagination">
      <ul>
    
      
      
    
      

      
        
        
          
            
            
          
        
          
        
          
            
            
          
        
          
        
          
            
            
          
        
          
        
          
            
            
          
        
          
        
          
        
          
            
            
          
        
          
            
            
              <li class="prev">
                <a href="/tutorials/phonebook-tutorial/1.1.4/phonebook-derived-columns" title="Derive Data">
                &larr; Previous
                </a>
              </li>
            
          
        
          
        
          
            
            
          
        
          
        
          
        
          
            
            
          
        
      

      
      
        
        
          
            
            
          
        
          
        
          
            
            
          
        
          
        
          
            
            
          
        
          
        
          
            
            
          
        
          
        
          
        
          
            
            
          
        
          
            
            
          
        
          
        
          
            
            
              <li class="next">
                <a href="/tutorials/phonebook-tutorial/1.1.4/phonebook-delete" title="Delete Contacts">
                Next &rarr;
                </a>
              </li>
            
          
        
          
        
          
        
          
            
            
          
        
      
      </ul>
    </div>
  </div>

  <div class="span3">
    
      
      
    
    <div class="side-toc">
    <div class="side-toc-inner">
      <h3>Phonebook Tutorial</h3>
      <ul>
        
          
          
            
              
                <li>
                  
                    <a href="/tutorials/phonebook-tutorial/1.1.4/phonebook-tutorial">Overview</a>
                  
                </li>
              
            
          
            
              
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
        
          
          
            
          
            
          
            
              
                <li>
                  
                    <a href="/tutorials/phonebook-tutorial/1.1.4/phonebook-setup">Setup</a>
                  
                </li>
              
            
          
            
              
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
        
          
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
              
            
          
            
              
                <li>
                  
                    <a href="/tutorials/phonebook-tutorial/1.1.4/phonebook-create">Create a Table</a>
                  
                </li>
              
            
          
        
          
          
            
          
            
          
            
          
            
          
            
              
                <li>
                  
                    <a href="/tutorials/phonebook-tutorial/1.1.4/phonebook-point-add">Read and Write in Kiji</a>
                  
                </li>
              
            
          
            
              
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
        
          
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
              
            
          
            
              
                <li>
                  
                    <a href="/tutorials/phonebook-tutorial/1.1.4/phonebook-import">Import Data</a>
                  
                </li>
              
            
          
            
          
            
          
            
          
            
          
            
          
            
          
        
          
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
              
                <li>
                  
                    <a href="/tutorials/phonebook-tutorial/1.1.4/phonebook-derived-columns">Derive Data</a>
                  
                </li>
              
            
          
            
              
            
          
            
          
            
          
            
          
            
          
        
          
          
            
          
            
          
            
          
            
          
            
          
            
          
            
              
                <li>
                  
                    <b>Use Counters</b>
                  
                </li>
              
            
          
            
              
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
        
          
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
              
                <li>
                  
                    <a href="/tutorials/phonebook-tutorial/1.1.4/phonebook-delete">Delete Contacts</a>
                  
                </li>
              
            
          
            
              
            
          
            
          
            
          
        
          
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
        
          
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
        
          
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
        
          
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
        
          
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
        
          
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
        
          
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
        
          
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
        
      </ul>
      <h3>Need Help?</h3>
      <ul>
        <li>
      <a class="btn btn-info"  href="https://groups.google.com/a/kiji.org/forum/?fromgroups#!forum/user">User Group Mailing List</a>
        </li>
        <li>
      <a class="btn btn-warning" href="https://jira.kiji.org/secure/CreateIssueDetails!init.jspa?pid=10004&issuetype=1&priority=3&components=10010&summary=Reported%20Docs%20Error:%20Use Counters&description=Please%20describe%20the%20issue.%0a%0aurl:%20/tutorials/phonebook-tutorial/1.1.4/phonebook-increment"> Report an Error in Docs </a> 
        </li>
    </ul>
    </div>
</div>

  </div>
</div>


      </div>

      <footer>
        <hr/>
        <p>&copy; Kiji Community</p>
      </footer>
    </div>

    


  <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-REMOVED-DONT-COMMIT']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>



  </body>
</html>

